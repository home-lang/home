// Integration Test: Building a Simple API Server

// ============================================================================
// USER MODEL AND VALIDATION
// ============================================================================

struct User {
    id: i32,
    name: string,
    email: string,
    age: i32,
}

impl User {
    fn validate(self): Result<(), string> {
        if (self.name.len() == 0) {
            return Err("name is required");
        }
        if (!self.email.contains("@")) {
            return Err("invalid email format");
        }
        if (self.age < 0 or self.age > 150) {
            return Err("age must be between 0 and 150");
        }
        return Ok(());
    }

    fn to_json(self): string {
        return json::stringify({
            "id": self.id,
            "name": self.name,
            "email": self.email,
            "age": self.age
        });
    }

    fn from_json(data: json::Value): Result<User, string> {
        let name = data["name"].as_string_or("");
        let email = data["email"].as_string_or("");
        let age = data["age"].as_int_or(0);

        let user = User {
            id: 0,
            name: name,
            email: email,
            age: age,
        };

        try user.validate();
        return Ok(user);
    }
}

// ============================================================================
// IN-MEMORY DATABASE
// ============================================================================

struct UserDB {
    users: Map<i32, User>,
    next_id: i32,
}

impl UserDB {
    fn new(): UserDB {
        return UserDB {
            users: {},
            next_id: 1,
        };
    }

    fn create(mut self, mut user: User): User {
        user.id = self.next_id;
        self.next_id = self.next_id + 1;
        self.users.insert(user.id, user);
        return user;
    }

    fn get(self, id: i32): Option<User> {
        return self.users.get(id);
    }

    fn all(self): [User] {
        return self.users.values().collect();
    }

    fn update(mut self, id: i32, updates: json::Value): Option<User> {
        if let Some(mut user) = self.users.get(id) {
            if (updates.has("name")) {
                user.name = updates["name"].as_string();
            }
            if (updates.has("email")) {
                user.email = updates["email"].as_string();
            }
            if (updates.has("age")) {
                user.age = updates["age"].as_int();
            }
            self.users.insert(id, user);
            return Some(user);
        }
        return None;
    }

    fn delete(mut self, id: i32): bool {
        return self.users.remove(id).is_some();
    }
}

// ============================================================================
// USER MODEL TESTS
// ============================================================================

it("should create valid user") {
    let user = User {
        id: 1,
        name: "Alice",
        email: "alice@example.com",
        age: 30,
    };
    assert(user.validate().is_ok());
}

it("should reject user with empty name") {
    let user = User {
        id: 1,
        name: "",
        email: "alice@example.com",
        age: 30,
    };
    assert(user.validate().is_err());
    assert(user.validate().unwrap_err() == "name is required");
}

it("should reject user with invalid email") {
    let user = User {
        id: 1,
        name: "Alice",
        email: "invalid-email",
        age: 30,
    };
    assert(user.validate().is_err());
    assert(user.validate().unwrap_err() == "invalid email format");
}

it("should reject user with invalid age") {
    let user = User {
        id: 1,
        name: "Alice",
        email: "alice@example.com",
        age: -5,
    };
    assert(user.validate().is_err());
}

it("should serialize user to JSON") {
    let user = User {
        id: 1,
        name: "Alice",
        email: "alice@example.com",
        age: 30,
    };
    let json_str = user.to_json();
    assert(json_str.contains("Alice"));
    assert(json_str.contains("alice@example.com"));
}

it("should deserialize user from JSON") {
    let data = json::parse("{\"name\":\"Bob\",\"email\":\"bob@example.com\",\"age\":25}");
    let result = User::from_json(data);
    assert(result.is_ok());
    let user = result.unwrap();
    assert(user.name == "Bob");
    assert(user.email == "bob@example.com");
    assert(user.age == 25);
}

it("should fail to deserialize invalid JSON") {
    let data = json::parse("{\"name\":\"\",\"email\":\"invalid\",\"age\":25}");
    let result = User::from_json(data);
    assert(result.is_err());
}

// ============================================================================
// DATABASE TESTS
// ============================================================================

it("should create user in database") {
    let mut db = UserDB::new();
    let user = User {
        id: 0,
        name: "Alice",
        email: "alice@example.com",
        age: 30,
    };
    let created = db.create(user);
    assert(created.id == 1);
}

it("should auto-increment IDs") {
    let mut db = UserDB::new();
    let u1 = db.create(User { id: 0, name: "A", email: "a@test.com", age: 1 });
    let u2 = db.create(User { id: 0, name: "B", email: "b@test.com", age: 2 });
    let u3 = db.create(User { id: 0, name: "C", email: "c@test.com", age: 3 });

    assert(u1.id == 1);
    assert(u2.id == 2);
    assert(u3.id == 3);
}

it("should get user by ID") {
    let mut db = UserDB::new();
    let created = db.create(User {
        id: 0,
        name: "Alice",
        email: "alice@example.com",
        age: 30,
    });

    let found = db.get(created.id);
    assert(found.is_some());
    assert(found.unwrap().name == "Alice");
}

it("should return None for non-existent user") {
    let db = UserDB::new();
    assert(db.get(999).is_none());
}

it("should list all users") {
    let mut db = UserDB::new();
    db.create(User { id: 0, name: "A", email: "a@test.com", age: 1 });
    db.create(User { id: 0, name: "B", email: "b@test.com", age: 2 });
    db.create(User { id: 0, name: "C", email: "c@test.com", age: 3 });

    let users = db.all();
    assert(users.len() == 3);
}

it("should update user") {
    let mut db = UserDB::new();
    let created = db.create(User {
        id: 0,
        name: "Alice",
        email: "alice@example.com",
        age: 30,
    });

    let updates = json::parse("{\"name\":\"Alice Smith\",\"age\":31}");
    let updated = db.update(created.id, updates);

    assert(updated.is_some());
    assert(updated.unwrap().name == "Alice Smith");
    assert(updated.unwrap().age == 31);
    assert(updated.unwrap().email == "alice@example.com");  // Unchanged
}

it("should delete user") {
    let mut db = UserDB::new();
    let created = db.create(User {
        id: 0,
        name: "Alice",
        email: "alice@example.com",
        age: 30,
    });

    assert(db.delete(created.id) == true);
    assert(db.get(created.id).is_none());
}

it("should return false when deleting non-existent user") {
    let mut db = UserDB::new();
    assert(db.delete(999) == false);
}

// ============================================================================
// API HANDLER SIMULATION
// ============================================================================

fn handle_get_users(db: &UserDB): http::Response {
    let users = db.all();
    let json_users = users.map(|u| u.to_json());
    return http::Response::new(200, "OK")
        .json(json_users);
}

fn handle_get_user(db: &UserDB, id: i32): http::Response {
    match db.get(id) {
        Some(user) => http::Response::new(200, "OK").json(user.to_json()),
        None => http::Response::new(404, "Not Found").json("{\"error\":\"User not found\"}"),
    }
}

fn handle_create_user(db: &mut UserDB, body: string): http::Response {
    let data = json::parse(body);
    match User::from_json(data) {
        Ok(user) => {
            let created = db.create(user);
            http::Response::new(201, "Created").json(created.to_json())
        },
        Err(e) => {
            http::Response::new(400, "Bad Request").json("{\"error\":\"" + e + "\"}")
        },
    }
}

fn handle_delete_user(db: &mut UserDB, id: i32): http::Response {
    if (db.delete(id)) {
        http::Response::new(204, "No Content")
    } else {
        http::Response::new(404, "Not Found").json("{\"error\":\"User not found\"}")
    }
}

it("should handle GET /users") {
    let mut db = UserDB::new();
    db.create(User { id: 0, name: "Alice", email: "a@test.com", age: 30 });
    db.create(User { id: 0, name: "Bob", email: "b@test.com", age: 25 });

    let response = handle_get_users(&db);
    assert(response.status() == 200);
}

it("should handle GET /users/:id success") {
    let mut db = UserDB::new();
    let created = db.create(User { id: 0, name: "Alice", email: "a@test.com", age: 30 });

    let response = handle_get_user(&db, created.id);
    assert(response.status() == 200);
}

it("should handle GET /users/:id not found") {
    let db = UserDB::new();

    let response = handle_get_user(&db, 999);
    assert(response.status() == 404);
}

it("should handle POST /users success") {
    let mut db = UserDB::new();
    let body = "{\"name\":\"Alice\",\"email\":\"alice@example.com\",\"age\":30}";

    let response = handle_create_user(&mut db, body);
    assert(response.status() == 201);
    assert(db.all().len() == 1);
}

it("should handle POST /users validation error") {
    let mut db = UserDB::new();
    let body = "{\"name\":\"\",\"email\":\"invalid\",\"age\":30}";

    let response = handle_create_user(&mut db, body);
    assert(response.status() == 400);
}

it("should handle DELETE /users/:id success") {
    let mut db = UserDB::new();
    let created = db.create(User { id: 0, name: "Alice", email: "a@test.com", age: 30 });

    let response = handle_delete_user(&mut db, created.id);
    assert(response.status() == 204);
}

it("should handle DELETE /users/:id not found") {
    let mut db = UserDB::new();

    let response = handle_delete_user(&mut db, 999);
    assert(response.status() == 404);
}

// ============================================================================
// FULL WORKFLOW TEST
// ============================================================================

it("should handle complete CRUD workflow") {
    let mut db = UserDB::new();

    // Create user
    let create_body = "{\"name\":\"Alice\",\"email\":\"alice@example.com\",\"age\":30}";
    let create_response = handle_create_user(&mut db, create_body);
    assert(create_response.status() == 201);

    // Get all users
    let list_response = handle_get_users(&db);
    assert(list_response.status() == 200);
    assert(db.all().len() == 1);

    // Get specific user
    let get_response = handle_get_user(&db, 1);
    assert(get_response.status() == 200);

    // Update user
    let updates = json::parse("{\"name\":\"Alice Smith\"}");
    let updated = db.update(1, updates);
    assert(updated.is_some());
    assert(updated.unwrap().name == "Alice Smith");

    // Delete user
    let delete_response = handle_delete_user(&mut db, 1);
    assert(delete_response.status() == 204);

    // Verify deleted
    let get_deleted_response = handle_get_user(&db, 1);
    assert(get_deleted_response.status() == 404);
}
