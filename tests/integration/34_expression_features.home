// Integration tests for new expression features
// Tests: if expressions, match expressions, Elvis operator, safe indexing

// ============================================
// IF EXPRESSIONS - if as an expression that returns a value
// ============================================

fn test_if_expression_basic() {
    let x = 10
    let result = if (x > 5) { 100 } else { 0 }
    assert(result == 100)

    let y = 3
    let result2 = if (y > 5) { 100 } else { 0 }
    assert(result2 == 0)
}

fn test_if_expression_with_strings() {
    let code = 200
    let status = if (code == 200) { "ok" } else { "error" }
    assert(status == "ok")

    let code2 = 404
    let status2 = if (code2 == 200) { "ok" } else { "error" }
    assert(status2 == "error")
}

fn test_if_expression_nested() {
    let x = 15
    let category = if (x < 10) { "small" } else { if (x < 20) { "medium" } else { "large" } }
    assert(category == "medium")
}

// ============================================
// MATCH EXPRESSIONS - pattern matching as expressions
// ============================================

enum Color {
    Red,
    Green,
    Blue
}

fn test_match_expression_basic() {
    let x = 2
    let name = match x {
        1 => "one",
        2 => "two",
        3 => "three",
        _ => "other"
    }
    assert(name == "two")
}

fn test_match_expression_enum() {
    let color = Color.Green
    let hex = match color {
        Color.Red => "#FF0000",
        Color.Green => "#00FF00",
        Color.Blue => "#0000FF"
    }
    assert(hex == "#00FF00")
}

fn test_match_expression_with_guard() {
    let x = 15
    let category = match x {
        n if (n < 0) => "negative",
        n if (n == 0) => "zero",
        n if (n < 10) => "small",
        n if (n < 100) => "medium",
        _ => "large"
    }
    assert(category == "medium")
}

// ============================================
// ELVIS OPERATOR (?:) - null coalescing alternative
// ============================================

fn test_elvis_basic() {
    let value: ?int = null
    let result = value ?: 42
    assert(result == 42)

    let value2: ?int = 10
    let result2 = value2 ?: 42
    assert(result2 == 10)
}

fn test_elvis_with_strings() {
    let name: ?string = null
    let display = name ?: "Anonymous"
    assert(display == "Anonymous")

    let name2: ?string = "Alice"
    let display2 = name2 ?: "Anonymous"
    assert(display2 == "Alice")
}

fn test_elvis_chained() {
    let a: ?int = null
    let b: ?int = null
    let c: ?int = 5

    // Should return first non-null value
    let result = a ?: b ?: c ?: 0
    assert(result == 5)
}

// ============================================
// SAFE INDEX OPERATOR (?[]) - safe array/map access
// ============================================

fn test_safe_index_array() {
    let arr = [1, 2, 3, 4, 5]

    // Valid index
    let first = arr?[0]
    assert(first == 1)

    // Out of bounds - returns null
    let oob = arr?[10]
    assert(oob == null)
}

fn test_safe_index_with_elvis() {
    let arr = [10, 20, 30]

    // Combine safe index with elvis for default value
    let value = arr?[5] ?: -1
    assert(value == -1)

    let value2 = arr?[1] ?: -1
    assert(value2 == 20)
}

fn test_safe_index_nullable_array() {
    let arr: ?[]int = null

    // Safe index on null array
    let result = arr?[0]
    assert(result == null)
}

// ============================================
// COMBINED USAGE
// ============================================

fn test_combined_features() {
    let items = [10, 20, 30]
    let index = 5

    // Combine safe index, elvis, and if expression
    let value = items?[index] ?: 0
    let message = if (value > 0) { "found" } else { "not found" }
    assert(message == "not found")

    let index2 = 1
    let value2 = items?[index2] ?: 0
    let message2 = if (value2 > 0) { "found" } else { "not found" }
    assert(message2 == "found")
}

fn test_match_with_safe_index() {
    let arr = [1, 2, 3]
    let idx = 1

    let result = match arr?[idx] {
        null => "missing",
        1 => "one",
        2 => "two",
        _ => "other"
    }
    assert(result == "two")
}

// Main test runner
fn main() {
    // If expressions
    test_if_expression_basic()
    test_if_expression_with_strings()
    test_if_expression_nested()

    // Match expressions
    test_match_expression_basic()
    test_match_expression_enum()
    test_match_expression_with_guard()

    // Elvis operator
    test_elvis_basic()
    test_elvis_with_strings()
    test_elvis_chained()

    // Safe index
    test_safe_index_array()
    test_safe_index_with_elvis()
    test_safe_index_nullable_array()

    // Combined
    test_combined_features()
    test_match_with_safe_index()

    print("All expression feature tests passed!")
}
