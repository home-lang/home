// Environment Variables Test Suite

// ============================================================================
// GET ENVIRONMENT VARIABLES
// ============================================================================

it("should get existing environment variable") {
    let path = env::get("PATH");
    assert(path != null);
    assert(path.len() > 0);
}

it("should return null for missing variable") {
    let missing = env::get("THIS_VAR_DOES_NOT_EXIST_12345");
    assert(missing == null);
}

it("should get with default value") {
    let val = env::get_or("MISSING_VAR", "default");
    assert(val == "default");
}

it("should check if variable exists") {
    assert(env::has("PATH") == true);
    assert(env::has("NONEXISTENT_VAR_XYZ") == false);
}

// ============================================================================
// SET ENVIRONMENT VARIABLES
// ============================================================================

it("should set environment variable") {
    env::set("TEST_VAR_123", "test_value");
    assert(env::get("TEST_VAR_123") == "test_value");
}

it("should overwrite existing variable") {
    env::set("TEST_VAR_OVERWRITE", "original");
    env::set("TEST_VAR_OVERWRITE", "updated");
    assert(env::get("TEST_VAR_OVERWRITE") == "updated");
}

it("should set empty value") {
    env::set("EMPTY_VAR", "");
    assert(env::get("EMPTY_VAR") == "");
}

// ============================================================================
// REMOVE ENVIRONMENT VARIABLES
// ============================================================================

it("should remove environment variable") {
    env::set("VAR_TO_REMOVE", "value");
    env::remove("VAR_TO_REMOVE");
    assert(env::get("VAR_TO_REMOVE") == null);
}

it("should not error removing nonexistent variable") {
    env::remove("NONEXISTENT_VAR_TO_REMOVE");
    // Should not throw
}

// ============================================================================
// LIST ALL VARIABLES
// ============================================================================

it("should list all environment variables") {
    let vars = env::all();
    assert(vars.len() > 0);
    assert(vars.contains_key("PATH"));
}

it("should iterate over variables") {
    let count = 0;
    for (key, value) in env::all() {
        count += 1;
        assert(key.len() > 0);
    }
    assert(count > 0);
}

// ============================================================================
// CURRENT WORKING DIRECTORY
// ============================================================================

it("should get current directory") {
    let cwd = env::current_dir();
    assert(cwd.len() > 0);
    assert(cwd.starts_with("/") or cwd[1] == ':');  // Unix or Windows
}

it("should change current directory") {
    let original = env::current_dir();
    env::set_current_dir("/tmp");
    assert(env::current_dir() == "/tmp");
    env::set_current_dir(original);
}

// ============================================================================
// HOME AND USER DIRECTORIES
// ============================================================================

it("should get home directory") {
    let home = env::home_dir();
    assert(home != null);
    assert(home.len() > 0);
}

it("should get temp directory") {
    let temp = env::temp_dir();
    assert(temp != null);
    assert(temp.len() > 0);
}

it("should get username") {
    let user = env::user();
    assert(user != null);
    assert(user.len() > 0);
}

// ============================================================================
// EXECUTABLE PATH
// ============================================================================

it("should get current executable path") {
    let exe = env::current_exe();
    assert(exe != null);
    assert(exe.len() > 0);
}

// ============================================================================
// OPERATING SYSTEM INFO
// ============================================================================

it("should get OS name") {
    let os = env::os();
    assert(os == "linux" or os == "macos" or os == "windows");
}

it("should get OS family") {
    let family = env::os_family();
    assert(family == "unix" or family == "windows");
}

it("should get architecture") {
    let arch = env::arch();
    assert(arch == "x86_64" or arch == "aarch64" or arch == "arm" or arch == "x86");
}

// ============================================================================
// PATH MANIPULATION
// ============================================================================

it("should parse PATH variable") {
    let paths = env::path_list();
    assert(paths.len() > 0);
}

it("should add to PATH") {
    let original_count = env::path_list().len();
    env::add_to_path("/custom/bin");
    assert(env::path_list().len() == original_count + 1);
}

it("should find executable in PATH") {
    let ls_path = env::which("ls");
    assert(ls_path != null);
}

it("should return null for missing executable") {
    let missing = env::which("nonexistent_command_xyz");
    assert(missing == null);
}

// ============================================================================
// COMMAND LINE ARGUMENTS
// ============================================================================

it("should get command line arguments") {
    let args = env::args();
    assert(args.len() >= 1);  // At least the program name
}

it("should get program name") {
    let program = env::args()[0];
    assert(program.len() > 0);
}

// ============================================================================
// SPECIAL VARIABLES
// ============================================================================

it("should expand variables in string") {
    env::set("MY_VAR", "world");
    let expanded = env::expand("Hello $MY_VAR!");
    assert(expanded == "Hello world!");
}

it("should expand with curly braces") {
    env::set("NAME", "test");
    let expanded = env::expand("Value: ${NAME}");
    assert(expanded == "Value: test");
}

it("should handle missing variable in expansion") {
    let expanded = env::expand("$UNDEFINED_VAR_XYZ");
    assert(expanded == "" or expanded == "$UNDEFINED_VAR_XYZ");
}

// ============================================================================
// SCOPED ENVIRONMENT
// ============================================================================

it("should create scoped environment") {
    let original = env::get("SCOPED_TEST");

    env::with({ "SCOPED_TEST": "temporary" }) {
        assert(env::get("SCOPED_TEST") == "temporary");
    }

    assert(env::get("SCOPED_TEST") == original);
}

it("should restore after scope exit") {
    env::set("RESTORE_TEST", "original");

    env::with({ "RESTORE_TEST": "changed" }) {
        // Value is changed inside scope
    }

    assert(env::get("RESTORE_TEST") == "original");
}

