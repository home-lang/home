// Pub/Sub Messaging Test Suite
// Tests actual pubsub module implementation

// ============================================================================
// PUBSUB CREATION
// ============================================================================

it("should create pubsub instance") {
    let ps = pubsub::new();
    assert(ps != null);
}

it("should create pubsub with PubSub type") {
    let ps = pubsub::PubSub();
    assert(ps != null);
}

it("should have subscribers field") {
    let ps = pubsub::new();
    assert(ps.subscribers != null);
}

// ============================================================================
// SUBSCRIBE AND PUBLISH
// ============================================================================

it("should subscribe to topic") {
    let ps = pubsub::new();
    let subscription = ps.subscribe("events");
    assert(subscription != null);
    assert(subscription.topic == "events");
    assert(subscription.active == true);
}

it("should publish message to subscriber") {
    let ps = pubsub::new();
    let received = null;

    ps.subscribe("events", |msg| {
        received = msg;
    });

    ps.publish("events", "hello");
    assert(received == "hello");
}

it("should publish object message") {
    let ps = pubsub::new();
    let received = null;

    ps.subscribe("users", |msg| {
        received = msg;
    });

    ps.publish("users", { id: 123, name: "John" });
    assert(received.id == 123);
    assert(received.name == "John");
}

it("should track subscriber count") {
    let ps = pubsub::new();

    assert(ps.subscriber_count() == 0);

    ps.subscribe("topic1", |msg| {});
    assert(ps.subscriber_count() == 1);

    ps.subscribe("topic2", |msg| {});
    assert(ps.subscriber_count() == 2);
}

it("should list topics") {
    let ps = pubsub::new();

    ps.subscribe("events", |msg| {});
    ps.subscribe("users", |msg| {});

    let topics = ps.topics();
    assert(topics.len() == 2);
}

// ============================================================================
// REDIS PUBSUB
// ============================================================================

it("should create Redis pubsub") {
    let ps = pubsub::redis("redis://localhost:6379");
    assert(ps != null);
    assert(ps.type == "redis");
}

// ============================================================================
// KAFKA PUBSUB
// ============================================================================

it("should create Kafka pubsub") {
    let kafka = pubsub::kafka("localhost:9092");
    assert(kafka != null);
    assert(kafka.type == "kafka");
}

// ============================================================================
// RABBITMQ PUBSUB
// ============================================================================

it("should create RabbitMQ pubsub") {
    let mq = pubsub::rabbitmq("amqp://localhost:5672");
    assert(mq != null);
    assert(mq.type == "rabbitmq");
}

// ============================================================================
// SUBSCRIPTION
// ============================================================================

it("should return subscription object") {
    let ps = pubsub::new();
    let sub = ps.subscribe("events", |msg| {});

    assert(sub.topic == "events");
    assert(sub.active == true);
}

it("should unsubscribe") {
    let ps = pubsub::new();
    let sub = ps.subscribe("events", |msg| {});

    sub.unsubscribe();
    // unsubscribe should complete without error
}

it("should check if subscription is active") {
    let ps = pubsub::new();
    let sub = ps.subscribe("events", |msg| {});

    assert(sub.is_active() == true);
}
