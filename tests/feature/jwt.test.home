// JWT (JSON Web Token) Test Suite

// ============================================================================
// JWT CREATION
// ============================================================================

it("should create JWT with default algorithm") {
    let payload = {
        sub: "1234567890",
        name: "John Doe",
        iat: 1516239022,
    };
    let token = JWT.sign(payload, "your-256-bit-secret");
    assert(token.split(".").len() == 3);
}

it("should decode JWT header") {
    let payload = { sub: "user123" };
    let token = JWT.sign(payload, "secret");
    let header = JWT.decodeHeader(token);
    assert(header["alg"] == "HS256");
}

// ============================================================================
// JWT VERIFICATION
// ============================================================================

it("should verify valid JWT") {
    let payload = { sub: "123" };
    let token = JWT.sign(payload, "secret");
    let decoded = JWT.verify(token, "secret");
    assert(decoded["sub"] == "123");
}

it("should reject invalid signature") {
    let payload = { sub: "123" };
    let token = JWT.sign(payload, "secret1");
    let result = JWT.verifySafe(token, "secret2");
    assert(result.is_err() == true);
}

it("should reject tampered token") {
    let payload = { sub: "123" };
    let token = JWT.sign(payload, "secret");
    // Tamper with payload
    let parts = token.split(".");
    let tampered = parts[0] + "." + "invalid" + "." + parts[2];
    let result = JWT.verifySafe(tampered, "secret");
    assert(result.is_err() == true);
}

// ============================================================================
// JWT CLAIMS
// ============================================================================

it("should include standard claims") {
    let now = Time.now();
    let payload = {
        sub: "123",
        iss: "auth-server",
        aud: "api-server",
        exp: now + 3600,
        nbf: now,
        iat: now,
        jti: UUID.v4(),
    };
    let token = JWT.sign(payload, "secret");
    let decoded = JWT.verify(token, "secret");
    assert(decoded["sub"] == "123");
    assert(decoded["iss"] == "auth-server");
}

it("should validate expiration") {
    let payload = {
        sub: "123",
        exp: Time.now() - 3600,  // Expired
    };
    let token = JWT.sign(payload, "secret");
    let result = JWT.verifySafe(token, "secret");
    assert(result.is_err() == true);
}

it("should validate not before") {
    let payload = {
        sub: "123",
        nbf: Time.now() + 3600,  // Not valid yet
    };
    let token = JWT.sign(payload, "secret");
    let result = JWT.verifySafe(token, "secret");
    assert(result.is_err() == true);
}

// ============================================================================
// JWT DECODING
// ============================================================================

it("should decode header") {
    let payload = { sub: "123" };
    let token = JWT.sign(payload, "secret");
    let header = JWT.decodeHeader(token);
    assert(header["typ"] == "JWT");
    assert(header["alg"] == "HS256");
}

it("should decode payload without verification") {
    let payload = { sub: "123", name: "John" };
    let token = JWT.sign(payload, "secret");
    let decoded = JWT.decode(token);  // No verification
    assert(decoded["sub"] == "123");
    assert(decoded["name"] == "John");
}

// ============================================================================
// JWT REFRESH
// ============================================================================

it("should refresh token") {
    let payload = {
        sub: "123",
        exp: Time.now() + 60,
    };
    let original = JWT.sign(payload, "secret");
    let refreshed = JWT.refresh(original, "secret", 3600);
    let decoded = JWT.verify(refreshed, "secret");
    assert(decoded["exp"] > Time.now() + 3500);
}

// ============================================================================
// ALGORITHMS
// ============================================================================

it("should support HS256 by default") {
    let payload = { sub: "123" };
    let token = JWT.sign(payload, "secret");
    let header = JWT.decodeHeader(token);
    assert(header["alg"] == "HS256");
}

// ============================================================================
// KEY PAIRS
// ============================================================================

it("should generate RSA key pair") {
    let keys = JWT.generateRsaKeys(2048);
    assert(keys.public_key.starts_with("-----BEGIN"));
    assert(keys.private_key.starts_with("-----BEGIN"));
}

it("should sign and verify with RSA") {
    let keys = JWT.generateRsaKeys(2048);
    let payload = { sub: "123" };
    let token = JWT.signRsa(payload, keys.private_key);
    let decoded = JWT.verifyRsa(token, keys.public_key);
    assert(decoded["sub"] == "123");
}

it("should generate EC key pair") {
    let keys = JWT.generateEcKeys();
    assert(keys.public_key.len() > 0);
    assert(keys.private_key.len() > 0);
}

// ============================================================================
// JWK (JSON Web Key)
// ============================================================================

it("should convert to JWK") {
    let keys = JWT.generateRsaKeys(2048);
    let jwk = JWT.toJwk(keys.public_key);
    assert(jwk["kty"] == "RSA");
    assert(jwk["n"] != null);
    assert(jwk["e"] != null);
}

it("should convert from JWK") {
    let jwk = {
        kty: "RSA",
        n: "0vx7agoebGcQSuu...",
        e: "AQAB",
    };
    let key = JWT.fromJwk(jwk);
    assert(key.len() > 0);
}

it("should fetch JWKS") {
    // Mock JWKS endpoint
    let jwks = JWT.fetchJwks("https://example.com/.well-known/jwks.json");
    assert(jwks["keys"].len() >= 0);
}

// ============================================================================
// CUSTOM HEADERS
// ============================================================================

it("should add custom header") {
    let payload = { sub: "123" };
    let headers = { kid: "key-id-1" };
    let token = JWT.signWithHeaders(payload, "secret", headers);
    let header = JWT.decodeHeader(token);
    assert(header["kid"] == "key-id-1");
}

// ============================================================================
// TOKEN VALIDATION OPTIONS
// ============================================================================

it("should allow clock skew") {
    let payload = {
        sub: "123",
        exp: Time.now() - 30,  // Expired 30 seconds ago
    };
    let token = JWT.sign(payload, "secret");
    // Allow 60 seconds of clock skew
    let decoded = JWT.verifyWithTolerance(token, "secret", 60);
    assert(decoded["sub"] == "123");
}

// ============================================================================
// ERROR HANDLING
// ============================================================================

it("should handle malformed token") {
    let result = JWT.verifySafe("not.a.valid.token", "secret");
    assert(result.is_err() == true);
}

it("should handle missing algorithm") {
    let result = JWT.verifySafe("eyJhbGciOiJub25lIn0.eyJzdWIiOiIxMjMifQ.", "secret");
    assert(result.is_err() == true);
}

// ============================================================================
// BLACKLISTING
// ============================================================================

it("should check token blacklist") {
    let payload = { sub: "123", jti: "token-id-1" };
    let token = JWT.sign(payload, "secret");
    JWT.blacklistAdd("token-id-1");
    let is_blacklisted = JWT.blacklistContains("token-id-1");
    assert(is_blacklisted == true);
}

// ============================================================================
// TOKEN INTROSPECTION
// ============================================================================

it("should introspect token") {
    let payload = {
        sub: "123",
        exp: Time.now() + 3600,
    };
    let token = JWT.sign(payload, "secret");
    let info = JWT.introspect(token);
    assert(info.is_expired == false);
    assert(info.expires_in > 3500);
    assert(info.subject == "123");
}

