// Collection Methods Test Suite
// Tests Laravel-style collection methods on arrays

// ============================================================================
// MAP METHOD
// ============================================================================

it("should map array elements with closure") {
    let arr = [1, 2, 3, 4, 5];
    let doubled = arr.map(|x| x * 2);
    assert(doubled.len() == 5);
    assert(doubled[0] == 2);
    assert(doubled[1] == 4);
    assert(doubled[2] == 6);
    assert(doubled[3] == 8);
    assert(doubled[4] == 10);
}

it("should map empty array") {
    let arr: [i32] = [];
    let mapped = arr.map(|x| x * 2);
    assert(mapped.len() == 0);
}

it("should map single element") {
    let arr = [42];
    let mapped = arr.map(|x| x + 8);
    assert(mapped.len() == 1);
    assert(mapped[0] == 50);
}

it("should map strings") {
    let names = ["alice", "bob"];
    let uppercased = names.map(|s| s.upper());
    assert(uppercased[0] == "ALICE");
    assert(uppercased[1] == "BOB");
}

// ============================================================================
// FILTER METHOD
// ============================================================================

it("should filter array elements") {
    let arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    let evens = arr.filter(|x| x % 2 == 0);
    assert(evens.len() == 5);
    assert(evens[0] == 2);
    assert(evens[1] == 4);
    assert(evens[2] == 6);
}

it("should filter to empty array") {
    let arr = [1, 3, 5, 7];
    let evens = arr.filter(|x| x % 2 == 0);
    assert(evens.len() == 0);
}

it("should filter all elements pass") {
    let arr = [2, 4, 6, 8];
    let evens = arr.filter(|x| x % 2 == 0);
    assert(evens.len() == 4);
}

it("should filter single element") {
    let arr = [42];
    let filtered = arr.filter(|x| x > 40);
    assert(filtered.len() == 1);
    assert(filtered[0] == 42);
}

it("should filter strings by length") {
    let words = ["a", "abc", "ab", "abcd"];
    let long_words = words.filter(|s| s.len() >= 3);
    assert(long_words.len() == 2);
    assert(long_words[0] == "abc");
    assert(long_words[1] == "abcd");
}

// ============================================================================
// REDUCE METHOD
// ============================================================================

it("should reduce array to sum") {
    let arr = [1, 2, 3, 4, 5];
    let sum = arr.reduce(|acc, x| acc + x, 0);
    assert(sum == 15);
}

it("should reduce array to product") {
    let arr = [1, 2, 3, 4];
    let product = arr.reduce(|acc, x| acc * x, 1);
    assert(product == 24);
}

it("should reduce without initial value") {
    let arr = [1, 2, 3, 4, 5];
    let sum = arr.reduce(|acc, x| acc + x);
    assert(sum == 15);
}

it("should reduce single element with initial") {
    let arr = [10];
    let result = arr.reduce(|acc, x| acc + x, 5);
    assert(result == 15);
}

it("should reduce empty array with initial") {
    let arr: [i32] = [];
    let result = arr.reduce(|acc, x| acc + x, 100);
    assert(result == 100);
}

it("should reduce to find max manually") {
    let arr = [3, 1, 4, 1, 5, 9, 2, 6];
    let max = arr.reduce(|acc, x| if (x > acc) { x } else { acc });
    assert(max == 9);
}

// ============================================================================
// FIND METHOD
// ============================================================================

it("should find first matching element") {
    let arr = [1, 2, 3, 4, 5];
    let found = arr.find(|x| x > 3);
    assert(found == 4);
}

it("should find returns void when not found") {
    let arr = [1, 2, 3];
    let found = arr.find(|x| x > 10);
    assert(found is void);
}

it("should find first element") {
    let arr = [10, 20, 30];
    let found = arr.find(|x| x > 5);
    assert(found == 10);
}

it("should find last matching only") {
    let arr = [1, 2, 100];
    let found = arr.find(|x| x > 50);
    assert(found == 100);
}

// ============================================================================
// EVERY / ALL METHOD
// ============================================================================

it("should return true when all match") {
    let arr = [2, 4, 6, 8];
    let all_even = arr.every(|x| x % 2 == 0);
    assert(all_even == true);
}

it("should return false when one fails") {
    let arr = [2, 4, 5, 8];
    let all_even = arr.every(|x| x % 2 == 0);
    assert(all_even == false);
}

it("should return true for empty array") {
    let arr: [i32] = [];
    let result = arr.every(|x| x > 0);
    assert(result == true);
}

it("should use all alias") {
    let arr = [1, 2, 3, 4, 5];
    let all_positive = arr.all(|x| x > 0);
    assert(all_positive == true);
}

it("should check all strings non-empty") {
    let words = ["hello", "world", "test"];
    let all_nonempty = words.all(|s| s.len() > 0);
    assert(all_nonempty == true);
}

// ============================================================================
// SOME / ANY METHOD
// ============================================================================

it("should return true when any matches") {
    let arr = [1, 3, 5, 8, 9];
    let has_even = arr.some(|x| x % 2 == 0);
    assert(has_even == true);
}

it("should return false when none match") {
    let arr = [1, 3, 5, 7];
    let has_even = arr.some(|x| x % 2 == 0);
    assert(has_even == false);
}

it("should return false for empty array") {
    let arr: [i32] = [];
    let result = arr.some(|x| x > 0);
    assert(result == false);
}

it("should use any alias") {
    let arr = [1, 2, 3, 4, 5];
    let has_five = arr.any(|x| x == 5);
    assert(has_five == true);
}

// ============================================================================
// SUM METHOD
// ============================================================================

it("should sum integer array") {
    let arr = [1, 2, 3, 4, 5];
    assert(arr.sum() == 15);
}

it("should sum empty array") {
    let arr: [i32] = [];
    assert(arr.sum() == 0);
}

it("should sum single element") {
    let arr = [42];
    assert(arr.sum() == 42);
}

it("should sum negative numbers") {
    let arr = [-1, -2, -3, 4];
    assert(arr.sum() == -2);
}

// ============================================================================
// AVG / AVERAGE METHOD
// ============================================================================

it("should calculate average") {
    let arr = [2, 4, 6, 8];
    assert(arr.avg() == 5);
}

it("should use average alias") {
    let arr = [10, 20, 30];
    assert(arr.average() == 20);
}

it("should average single element") {
    let arr = [42];
    assert(arr.avg() == 42);
}

// ============================================================================
// MIN METHOD
// ============================================================================

it("should find minimum") {
    let arr = [3, 1, 4, 1, 5, 9];
    assert(arr.min() == 1);
}

it("should find min single element") {
    let arr = [42];
    assert(arr.min() == 42);
}

it("should find min with negatives") {
    let arr = [5, -3, 2, -10, 0];
    assert(arr.min() == -10);
}

// ============================================================================
// MAX METHOD
// ============================================================================

it("should find maximum") {
    let arr = [3, 1, 4, 1, 5, 9];
    assert(arr.max() == 9);
}

it("should find max single element") {
    let arr = [42];
    assert(arr.max() == 42);
}

it("should find max with negatives") {
    let arr = [-5, -3, -2, -10];
    assert(arr.max() == -2);
}

// ============================================================================
// UNIQUE METHOD
// ============================================================================

it("should remove duplicates") {
    let arr = [1, 2, 2, 3, 3, 3, 4];
    let unique = arr.unique();
    assert(unique.len() == 4);
    assert(unique[0] == 1);
    assert(unique[1] == 2);
    assert(unique[2] == 3);
    assert(unique[3] == 4);
}

it("should handle no duplicates") {
    let arr = [1, 2, 3, 4, 5];
    let unique = arr.unique();
    assert(unique.len() == 5);
}

it("should handle all duplicates") {
    let arr = [5, 5, 5, 5, 5];
    let unique = arr.unique();
    assert(unique.len() == 1);
    assert(unique[0] == 5);
}

it("should unique empty array") {
    let arr: [i32] = [];
    let unique = arr.unique();
    assert(unique.len() == 0);
}

// ============================================================================
// TAKE METHOD
// ============================================================================

it("should take first n elements") {
    let arr = [1, 2, 3, 4, 5];
    let first3 = arr.take(3);
    assert(first3.len() == 3);
    assert(first3[0] == 1);
    assert(first3[1] == 2);
    assert(first3[2] == 3);
}

it("should take more than length") {
    let arr = [1, 2, 3];
    let taken = arr.take(10);
    assert(taken.len() == 3);
}

it("should take zero elements") {
    let arr = [1, 2, 3];
    let taken = arr.take(0);
    assert(taken.len() == 0);
}

it("should take from empty array") {
    let arr: [i32] = [];
    let taken = arr.take(5);
    assert(taken.len() == 0);
}

// ============================================================================
// SKIP METHOD
// ============================================================================

it("should skip first n elements") {
    let arr = [1, 2, 3, 4, 5];
    let after2 = arr.skip(2);
    assert(after2.len() == 3);
    assert(after2[0] == 3);
    assert(after2[1] == 4);
    assert(after2[2] == 5);
}

it("should skip more than length") {
    let arr = [1, 2, 3];
    let skipped = arr.skip(10);
    assert(skipped.len() == 0);
}

it("should skip zero elements") {
    let arr = [1, 2, 3];
    let skipped = arr.skip(0);
    assert(skipped.len() == 3);
    assert(skipped[0] == 1);
}

it("should skip from empty array") {
    let arr: [i32] = [];
    let skipped = arr.skip(5);
    assert(skipped.len() == 0);
}

// ============================================================================
// FLATTEN METHOD
// ============================================================================

it("should flatten nested arrays") {
    let arr = [[1, 2], [3, 4], [5]];
    let flat = arr.flatten();
    assert(flat.len() == 5);
    assert(flat[0] == 1);
    assert(flat[1] == 2);
    assert(flat[2] == 3);
    assert(flat[3] == 4);
    assert(flat[4] == 5);
}

it("should flatten already flat array") {
    let arr = [1, 2, 3, 4, 5];
    let flat = arr.flatten();
    assert(flat.len() == 5);
    assert(flat[0] == 1);
}

it("should flatten empty nested arrays") {
    let arr: [[i32]] = [[], [], []];
    let flat = arr.flatten();
    assert(flat.len() == 0);
}

it("should flatten mixed empty and full") {
    let arr = [[], [1, 2], [], [3]];
    let flat = arr.flatten();
    assert(flat.len() == 3);
    assert(flat[0] == 1);
    assert(flat[1] == 2);
    assert(flat[2] == 3);
}

// ============================================================================
// SORT METHOD
// ============================================================================

it("should sort integers ascending") {
    let arr = [3, 1, 4, 1, 5, 9, 2, 6];
    let sorted = arr.sort();
    assert(sorted[0] == 1);
    assert(sorted[1] == 1);
    assert(sorted[2] == 2);
    assert(sorted[3] == 3);
    assert(sorted[4] == 4);
    assert(sorted[5] == 5);
    assert(sorted[6] == 6);
    assert(sorted[7] == 9);
}

it("should sort single element") {
    let arr = [42];
    let sorted = arr.sort();
    assert(sorted.len() == 1);
    assert(sorted[0] == 42);
}

it("should sort already sorted") {
    let arr = [1, 2, 3, 4, 5];
    let sorted = arr.sort();
    assert(sorted[0] == 1);
    assert(sorted[4] == 5);
}

it("should sort reverse sorted") {
    let arr = [5, 4, 3, 2, 1];
    let sorted = arr.sort();
    assert(sorted[0] == 1);
    assert(sorted[4] == 5);
}

it("should sort strings alphabetically") {
    let arr = ["banana", "apple", "cherry"];
    let sorted = arr.sort();
    assert(sorted[0] == "apple");
    assert(sorted[1] == "banana");
    assert(sorted[2] == "cherry");
}

// ============================================================================
// SORTDESC METHOD
// ============================================================================

it("should sort integers descending") {
    let arr = [3, 1, 4, 1, 5, 9, 2, 6];
    let sorted = arr.sortDesc();
    assert(sorted[0] == 9);
    assert(sorted[1] == 6);
    assert(sorted[2] == 5);
    assert(sorted[3] == 4);
    assert(sorted[4] == 3);
    assert(sorted[5] == 2);
    assert(sorted[6] == 1);
    assert(sorted[7] == 1);
}

it("should sortDesc single element") {
    let arr = [42];
    let sorted = arr.sortDesc();
    assert(sorted[0] == 42);
}

it("should sortDesc strings") {
    let arr = ["apple", "banana", "cherry"];
    let sorted = arr.sortDesc();
    assert(sorted[0] == "cherry");
    assert(sorted[1] == "banana");
    assert(sorted[2] == "apple");
}

// ============================================================================
// IS_EMPTY / ISEMPTY METHOD
// ============================================================================

it("should return true for empty array") {
    let arr: [i32] = [];
    assert(arr.is_empty() == true);
    assert(arr.isEmpty() == true);
}

it("should return false for non-empty array") {
    let arr = [1];
    assert(arr.is_empty() == false);
    assert(arr.isEmpty() == false);
}

// ============================================================================
// IS_NOT_EMPTY / ISNOTEMPTY METHOD
// ============================================================================

it("should return false for empty array") {
    let arr: [i32] = [];
    assert(arr.is_not_empty() == false);
    assert(arr.isNotEmpty() == false);
}

it("should return true for non-empty array") {
    let arr = [1, 2, 3];
    assert(arr.is_not_empty() == true);
    assert(arr.isNotEmpty() == true);
}

// ============================================================================
// COUNT METHOD
// ============================================================================

it("should count elements") {
    let arr = [1, 2, 3, 4, 5];
    assert(arr.count() == 5);
}

it("should count empty array") {
    let arr: [i32] = [];
    assert(arr.count() == 0);
}

it("should count single element") {
    let arr = [42];
    assert(arr.count() == 1);
}

// ============================================================================
// METHOD CHAINING
// ============================================================================

it("should chain map and filter") {
    let arr = [1, 2, 3, 4, 5];
    let result = arr.map(|x| x * 2).filter(|x| x > 5);
    assert(result.len() == 3);
    assert(result[0] == 6);
    assert(result[1] == 8);
    assert(result[2] == 10);
}

it("should chain filter and sum") {
    let arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    let even_sum = arr.filter(|x| x % 2 == 0).sum();
    assert(even_sum == 30);
}

it("should chain map, filter, reduce") {
    let arr = [1, 2, 3, 4, 5];
    let result = arr.map(|x| x * 2).filter(|x| x > 4).reduce(|acc, x| acc + x, 0);
    assert(result == 24);
}

it("should chain take and sum") {
    let arr = [10, 20, 30, 40, 50];
    let first3_sum = arr.take(3).sum();
    assert(first3_sum == 60);
}

it("should chain skip and avg") {
    let arr = [10, 20, 30, 40, 50];
    let last3_avg = arr.skip(2).avg();
    assert(last3_avg == 40);
}

it("should chain unique and sort") {
    let arr = [3, 1, 2, 1, 3, 2, 4];
    let result = arr.unique().sort();
    assert(result.len() == 4);
    assert(result[0] == 1);
    assert(result[1] == 2);
    assert(result[2] == 3);
    assert(result[3] == 4);
}

// ============================================================================
// EDGE CASES - MAP
// ============================================================================

it("should map with identity") {
    let arr = [1, 2, 3];
    let same = arr.map(|x| x);
    assert(same[0] == 1);
    assert(same[1] == 2);
    assert(same[2] == 3);
}

it("should map to constant") {
    let arr = [1, 2, 3, 4, 5];
    let zeros = arr.map(|x| 0);
    assert(zeros[0] == 0);
    assert(zeros[4] == 0);
}

it("should map with complex expression") {
    let arr = [1, 2, 3];
    let result = arr.map(|x| x * x + x);
    assert(result[0] == 2);
    assert(result[1] == 6);
    assert(result[2] == 12);
}

// ============================================================================
// EDGE CASES - FILTER
// ============================================================================

it("should filter with always true") {
    let arr = [1, 2, 3];
    let all = arr.filter(|x| true);
    assert(all.len() == 3);
}

it("should filter with always false") {
    let arr = [1, 2, 3];
    let none = arr.filter(|x| false);
    assert(none.len() == 0);
}

// ============================================================================
// EDGE CASES - REDUCE
// ============================================================================

it("should reduce to string concat") {
    let words = ["hello", " ", "world"];
    let sentence = words.reduce(|acc, s| acc + s, "");
    assert(sentence == "hello world");
}

// ============================================================================
// EDGE CASES - NESTED OPERATIONS
// ============================================================================

it("should handle nested arrays with map") {
    let matrix = [[1, 2], [3, 4]];
    let sums = matrix.map(|row| row.sum());
    assert(sums[0] == 3);
    assert(sums[1] == 7);
}

it("should filter nested arrays by condition") {
    let matrix = [[1, 2, 3], [4, 5], [6]];
    let long_rows = matrix.filter(|row| row.len() >= 2);
    assert(long_rows.len() == 2);
}

// ============================================================================
// EDGE CASES - ORIGINAL UNCHANGED
// ============================================================================

it("should not modify original array with map") {
    let original = [1, 2, 3];
    let doubled = original.map(|x| x * 2);
    assert(original[0] == 1);
    assert(doubled[0] == 2);
}

it("should not modify original array with filter") {
    let original = [1, 2, 3, 4, 5];
    let evens = original.filter(|x| x % 2 == 0);
    assert(original.len() == 5);
    assert(evens.len() == 2);
}

it("should not modify original array with sort") {
    let original = [3, 1, 2];
    let sorted = original.sort();
    assert(original[0] == 3);
    assert(sorted[0] == 1);
}

