// HTML Parsing and Manipulation Test Suite

// ============================================================================
// PARSING
// ============================================================================

it("should parse simple HTML and return document") {
    let doc = HTML.parse("<html><body><p>Hello</p></body></html>")
    assert(doc != null)
    assert(doc.text_content().contains("Hello"))
}

it("should parse HTML fragment with multiple children") {
    let fragment = HTML.parseFragment("<p>Hello</p><p>World</p>")
    let children = fragment.children()
    assert(children.len() == 2)
}

it("should handle malformed HTML gracefully") {
    let doc = HTML.parse("<p>Unclosed paragraph<div>Mixed</p></div>")
    assert(doc != null)
    // Parser should recover and still contain the text
    assert(doc.text_content().contains("Unclosed"))
}

it("should preserve text content accurately") {
    let doc = HTML.parse("<p>Hello World</p>")
    let text = doc.text_content()
    assert(text == "Hello World")
}

// ============================================================================
// QUERYING - TAG SELECTORS
// ============================================================================

it("should select elements by tag name") {
    let doc = HTML.parse("<div><p>One</p><p>Two</p><span>Three</span></div>")
    let paragraphs = doc.select("p")
    assert(paragraphs.len() == 2)
}

it("should select nested elements by tag") {
    let doc = HTML.parse("<div><ul><li>A</li><li>B</li></ul></div>")
    let items = doc.select("li")
    assert(items.len() == 2)
}

// ============================================================================
// QUERYING - ID SELECTORS
// ============================================================================

it("should select element by id") {
    let doc = HTML.parse("<div id=\"main\">Main Content</div><div id=\"sidebar\">Side</div>")
    let elem = doc.select_one("#main")
    assert(elem != null)
    assert(elem.text_content().contains("Main Content"))
}

it("should return null for non-existent id") {
    let doc = HTML.parse("<div id=\"exists\">Content</div>")
    let elem = doc.select_one("#nonexistent")
    // Should handle gracefully
}

// ============================================================================
// QUERYING - CLASS SELECTORS
// ============================================================================

it("should select elements by class") {
    let doc = HTML.parse("<p class=\"highlight\">Important</p><p>Normal</p><p class=\"highlight\">Also Important</p>")
    let highlighted = doc.select(".highlight")
    assert(highlighted.len() == 2)
}

it("should select element with specific class") {
    let doc = HTML.parse("<div class=\"active\">Active Card</div><div class=\"inactive\">Inactive</div>")
    let active = doc.select(".active")
    assert(active.len() == 1)
}

// ============================================================================
// QUERYING - ATTRIBUTE SELECTORS
// ============================================================================

it("should select elements with attribute present") {
    let doc = HTML.parse("<a href=\"/page1\">Link1</a><a href=\"/page2\">Link2</a><span>Text</span>")
    let links = doc.select("[href]")
    assert(links.len() == 2)
}

it("should select elements by attribute value") {
    let doc = HTML.parse("<input type=\"text\" name=\"user\"><input type=\"password\" name=\"pass\"><input type=\"text\" name=\"email\">")
    let text_inputs = doc.select("[type='text']")
    assert(text_inputs.len() == 2)
}

it("should select disabled inputs") {
    let doc = HTML.parse("<input disabled=\"true\" value=\"cant edit\"><input value=\"can edit\">")
    let disabled = doc.select("[disabled]")
    assert(disabled.len() == 1)
}

// ============================================================================
// ELEMENT COUNTING AND STRUCTURE
// ============================================================================

it("should count children correctly") {
    let doc = HTML.parse("<ul><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li></ul>")
    let items = doc.select("li")
    assert(items.len() == 5)
}

it("should find deeply nested elements") {
    let doc = HTML.parse("<div><section><article><p>Deep</p></article></section></div>")
    let paragraphs = doc.select("p")
    assert(paragraphs.len() == 1)
}

it("should handle empty elements") {
    let doc = HTML.parse("<div></div><div><p>Content</p></div>")
    let divs = doc.select("div")
    assert(divs.len() == 2)
}

// ============================================================================
// TEXT EXTRACTION
// ============================================================================

it("should extract text from nested elements") {
    let doc = HTML.parse("<div><p>Hello</p><p>World</p></div>")
    let text = doc.text_content()
    assert(text.contains("Hello"))
    assert(text.contains("World"))
}

it("should handle whitespace in text content") {
    let doc = HTML.parse("<p>   Spaced   Text   </p>")
    let text = doc.text_content()
    assert(text.contains("Spaced"))
    assert(text.contains("Text"))
}

// ============================================================================
// SANITIZATION
// ============================================================================

it("should sanitize script tags") {
    let dirty = "<p>Safe</p><script>alert('xss')</script>"
    let clean = HTML.sanitize(dirty)
    assert(clean.contains("Safe"))
    // Script should be removed or escaped
}

it("should preserve allowed tags during sanitization") {
    let input = "<p><b>Bold</b> and <i>italic</i></p>"
    let clean = HTML.sanitize(input, allowed_tags: ["p", "b", "i"])
    assert(clean.contains("Bold"))
    assert(clean.contains("italic"))
}

it("should strip all HTML tags") {
    let input = "<div><p>Hello <b>World</b></p></div>"
    let text = HTML.stripTags(input)
    assert(text == "Hello World")
}

it("should preserve safe attributes") {
    let input = "<a href=\"/safe\" onclick=\"evil()\">Link</a>"
    let clean = HTML.sanitize(input, allowed_attrs: { "a": ["href"] })
    assert(clean.contains("href") or clean.contains("safe"))
}

// ============================================================================
// VALIDATION
// ============================================================================

it("should validate well-formed HTML") {
    let result = HTML.validate("<html><body><p>Valid</p></body></html>")
    assert(result.is_valid == true)
}

it("should detect unclosed tags") {
    let result = HTML.validate("<p>Unclosed")
    assert(result != null)
}

// ============================================================================
// ENCODING/DECODING
// ============================================================================

it("should encode HTML entities") {
    let encoded = HTML.encode("<script>alert('xss')</script>")
    assert(encoded.contains("&lt;") or encoded.contains("&gt;"))
    // Should not contain raw < or > that could execute
}

it("should decode HTML entities") {
    let decoded = HTML.decode("&lt;p&gt;Hello&lt;/p&gt;")
    assert(decoded.contains("<p>") or decoded.contains("Hello"))
}

it("should encode ampersands") {
    let encoded = HTML.encode("Tom & Jerry")
    assert(encoded.contains("&amp;") or encoded.contains("&"))
}

it("should encode quotes") {
    let encoded = HTML.encode("He said \"Hello\"")
    assert(encoded.contains("&quot;") or encoded.contains("Hello"))
}

// ============================================================================
// COMPLEX QUERIES
// ============================================================================

it("should select by combined class and tag") {
    let doc = HTML.parse("<p class=\"intro\">First</p><div class=\"intro\">Second</div><p>Third</p>")
    let intro_paragraphs = doc.select(".intro")
    assert(intro_paragraphs.len() == 2)
}

it("should handle multiple same-level elements") {
    let doc = HTML.parse("<span>A</span><span>B</span><span>C</span><span>D</span>")
    let spans = doc.select("span")
    assert(spans.len() == 4)
}

// ============================================================================
// EDGE CASES
// ============================================================================

it("should handle empty document") {
    let doc = HTML.parse("")
    assert(doc != null)
}

it("should handle text-only content") {
    let doc = HTML.parse("Just plain text")
    assert(doc.text_content().contains("plain text"))
}

it("should handle self-closing tags") {
    let doc = HTML.parse("<div><br/><hr/><img src=\"test.png\"/></div>")
    assert(doc != null)
}

it("should handle comments") {
    let doc = HTML.parse("<p>Before</p><!-- comment --><p>After</p>")
    let paragraphs = doc.select("p")
    assert(paragraphs.len() == 2)
}
